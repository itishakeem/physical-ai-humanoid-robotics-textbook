"use strict";(globalThis.webpackChunkmy_book=globalThis.webpackChunkmy_book||[]).push([[8852],{8852:(e,t,a)=>{a.r(t),a.d(t,{default:()=>h});var s=a(6540),o=a(8259),r=a(4769),n=a(4848);const l=r.i.BACKEND_URL,i=r.i.CHAT_HISTORY_URL,c=["Hello there!","Welcome to our AI Assistant!","Hi! How can I help you today?","Welcome! Ask me anything about humanoid robotics.","Hello! Ready to explore humanoid robotics?","Welcome! I'm here to help you learn."],d=()=>c[Math.floor(Math.random()*c.length)];function h(){const{user:e,token:t,isAuthenticated:a}=(0,o.A)(),[r,c]=(0,s.useState)(!1),[h,m]=(0,s.useState)([]),[u,g]=(0,s.useState)(null),[f,x]=(0,s.useState)([]),[p,y]=(0,s.useState)(""),[b,j]=(0,s.useState)(!1),[w,v]=(0,s.useState)(null),[N,C]=(0,s.useState)(!1),[k,S]=(0,s.useState)(!1),[E,T]=(0,s.useState)(""),[$,A]=(0,s.useState)(!0),_=(0,s.useRef)(null),D=(0,s.useRef)(null);(0,s.useEffect)(()=>{T(a&&e?`Welcome, ${e.first_name}!`:d())},[a,e]),(0,s.useEffect)(()=>{a&&0===h.length?H():a||(S(!1),x([]),m([]),g(null))},[a]),(0,s.useEffect)(()=>{u&&a&&O(u)},[u]);const z=()=>({Authorization:`Bearer ${t}`,"Content-Type":"application/json"}),H=async()=>{if(a)try{const e=await fetch(`${i}/chats`,{headers:z()});if(!e.ok)throw new Error("Failed to load chats");const t=(await e.json()).map(e=>({id:e.id,title:e.title,createdAt:e.created_at,updatedAt:e.updated_at,message_count:e.message_count}));m(t),t.length>0&&!u&&g(t[0].id)}catch(e){console.error("Error loading chats:",e)}finally{S(!1)}},O=async e=>{if(a)try{const t=await fetch(`${i}/chats/${e}`,{headers:z()});if(!t.ok)throw new Error("Failed to load messages");const a=await t.json();x(a.messages||[])}catch(t){console.error("Error loading messages:",t),x([])}};(0,s.useEffect)(()=>{_.current&&_.current.scrollTo({top:_.current.scrollHeight,behavior:"smooth"})},[f]),(0,s.useEffect)(()=>{r&&D.current&&setTimeout(()=>D.current.focus(),100)},[r]);const P=e=>{if(!e)return"";const t=new Date(e),a=new Date-t,s=Math.floor(a/6e4),o=Math.floor(a/36e5),r=Math.floor(a/864e5);return s<1?"Just now":s<60?`${s}m ago`:o<24?`${o}h ago`:r<7?`${r}d ago`:t.toLocaleDateString()},M=async()=>{if(!p.trim()||b)return;const t=p.trim();y("");let s=u;if(a&&!u)try{const e=await fetch(`${i}/chats`,{method:"POST",headers:z(),body:JSON.stringify({title:"New Conversation"})});if(!e.ok)throw new Error("Failed to create chat");const t=await e.json(),a={id:t.id,title:t.title,createdAt:t.created_at,updatedAt:t.updated_at,message_count:t.messages?.length||1};if(m(e=>[a,...e]),g(a.id),s=a.id,t.messages&&t.messages.length>0){const e=t.messages.map(e=>({role:e.role,text:e.text,id:e.id}));x(e)}}catch(n){console.error("Error creating new chat:",n),console.log("Falling back to anonymous chat mode")}const o={role:"user",text:t,id:Date.now()},r={role:"bot",text:"",id:Date.now()+1};x(e=>[...e,o,r]),j(!0);try{a&&s&&fetch(`${i}/chats/${s}/messages`,{method:"POST",headers:z(),body:JSON.stringify({role:"user",text:t})}).catch(e=>console.error("Error saving user message:",e));const o=f.slice(-10).map(e=>({role:"user"===e.role?"user":"assistant",content:e.text})),r=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,stream:!0,user_level:a&&e?e.developer_level:"Intermediate",conversation_history:o})});if(!r.ok)throw new Error("Network response was not ok");j(!1);const n=r.body.getReader(),d=new TextDecoder;let h="";try{for(;;){const{done:e,value:t}=await n.read();if(e){console.log("Stream completed. Total text length:",h.length);break}const a=d.decode(t,{stream:!0});h+=a,x(e=>{const t=[...e],a=t[t.length-1];return a&&"bot"===a.role&&(t[t.length-1]={...a,text:h}),t})}}catch(c){console.error("Streaming error:",c),console.log("Partial response received:",h.length,"characters")}a&&s&&fetch(`${i}/chats/${s}/messages`,{method:"POST",headers:z(),body:JSON.stringify({role:"bot",text:h})}).catch(e=>console.error("Error saving bot message:",e))}catch(n){console.error("Chat error:",n),x(e=>{const t=[...e];return t.pop(),t.push({role:"bot",text:"\u26a0\ufe0f Connection error. Please check if the backend is running on http://127.0.0.1:8000",id:Date.now()}),t}),j(!1)}},R=async(e,t)=>{if(t&&t.stopPropagation(),a)if(w===e){console.log("Deleting chat:",e);const t=h.filter(t=>t.id!==e);m(t),u===e&&(t.length>0?g(t[0].id):(g(null),x([]))),v(null);try{const t=await fetch(`${i}/chats/${e}`,{method:"DELETE",headers:z()});if(!t.ok){const e=await t.json().catch(()=>({detail:"Failed to delete chat"}));console.error("Delete chat error:",e),H()}console.log("Chat deleted successfully")}catch(s){console.error("Error deleting chat:",s),H()}}else v(e),setTimeout(()=>v(null),3e3)};return"undefined"==typeof window?null:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"fab",onClick:()=>c(!r),role:"button","aria-label":"Toggle chat",children:(0,n.jsx)("svg",{viewBox:"0 0 24 24",width:"30",height:"30",fill:"currentColor",style:{transform:r?"rotate(180deg)":"rotate(0)",transition:"transform 0.3s"},children:r?(0,n.jsx)("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}):(0,n.jsx)("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"})})}),r&&(0,n.jsxs)("div",{className:"chat-container",children:[(0,n.jsxs)("div",{className:"sidebar",children:[(0,n.jsxs)("div",{className:"sidebar-header",children:[(0,n.jsx)("button",{onClick:async()=>{if(!a)return x([]),void g(null);try{const e=await fetch(`${i}/chats`,{method:"POST",headers:z(),body:JSON.stringify({title:"New Conversation"})});if(!e.ok)throw new Error("Failed to create chat");const t=await e.json(),a={id:t.id,title:t.title,createdAt:t.created_at,updatedAt:t.updated_at,message_count:t.messages?.length||1};if(m(e=>[a,...e]),g(a.id),t.messages&&t.messages.length>0){const e=t.messages.map(e=>({role:e.role,text:e.text,id:e.id}));x(e)}}catch(e){console.error("Error creating new chat:",e),x([]),g(null)}},className:"new-chat-btn",disabled:b,children:(0,n.jsx)("span",{style:{position:"relative",zIndex:1},children:a?"+ New Chat":"Clear Chat"})}),h.length>0&&a&&(0,n.jsx)("button",{onClick:()=>C(!N),className:"clear-all-btn",title:"Clear all history",children:"\ud83d\uddd1\ufe0f Clear All"}),N&&(0,n.jsxs)("div",{className:"confirm-dialog",children:[(0,n.jsx)("p",{children:"Delete all chats?"}),(0,n.jsxs)("div",{className:"confirm-buttons",children:[(0,n.jsx)("button",{onClick:async()=>{if(a){m([]),g(null),x([]),C(!1);try{(await fetch(`${i}/chats`,{method:"DELETE",headers:z()})).ok||H()}catch(e){console.error("Error clearing all history:",e),H()}}},className:"confirm-yes",children:"Yes"}),(0,n.jsx)("button",{onClick:()=>C(!1),className:"confirm-no",children:"No"})]})]})]}),(0,n.jsx)("div",{className:"chat-list",children:a?k?(0,n.jsx)("div",{className:"empty-history",children:(0,n.jsx)("p",{children:"Loading..."})}):0===h.length?(0,n.jsxs)("div",{className:"empty-history",children:[(0,n.jsx)("p",{children:"No chat history"}),(0,n.jsx)("p",{className:"empty-hint",children:"Start a new conversation!"})]}):h.map(e=>(0,n.jsxs)("div",{className:`chat-item ${u===e.id?"active":""} ${w===e.id?"delete-confirm":""}`,onClick:()=>{g(e.id),v(null)},role:"button",tabIndex:0,children:[(0,n.jsxs)("div",{className:"chat-item-content",children:[(0,n.jsx)("span",{className:"chat-item-title",children:e.title}),e.createdAt&&(0,n.jsx)("span",{className:"chat-item-time",children:P(e.createdAt)})]}),w===e.id?(0,n.jsx)("button",{className:"delete-chat-btn confirm",onClick:t=>R(e.id,t),"aria-label":"Confirm delete",title:"Confirm delete",children:"\u2713"}):(0,n.jsx)("button",{className:"delete-chat-btn",onClick:t=>R(e.id,t),"aria-label":"Delete chat",title:"Delete chat",children:"\ud83d\uddd1\ufe0f"})]},e.id)):(0,n.jsxs)("div",{className:"empty-history",children:[(0,n.jsx)("p",{style:{fontSize:"13px",marginBottom:"8px"},children:"\ud83d\udcac Chat freely!"}),(0,n.jsx)("p",{className:"empty-hint",style:{fontSize:"12px",lineHeight:"1.4"},children:"Sign in to save your chat history across sessions"})]})})]}),(0,n.jsxs)("div",{className:"main-chat",children:[(0,n.jsxs)("div",{className:"header",children:[(0,n.jsxs)("div",{className:"header-left",children:[(0,n.jsx)("h3",{children:a&&e?`\ud83e\udd16 Welcome, ${e.first_name}!`:"\ud83e\udd16 Humanoid Robotics Expert"}),u&&a&&(0,n.jsx)("button",{onClick:async()=>{if(u&&a&&window.confirm("Clear all messages in this chat? This cannot be undone."))try{if(!(await fetch(`${i}/chats/${u}/clear`,{method:"PUT",headers:z()})).ok)throw new Error("Failed to clear chat");await O(u)}catch(e){console.error("Error clearing chat:",e),alert("Failed to clear chat. Please try again.")}},className:"clear-chat-btn",title:"Clear current chat","aria-label":"Clear current chat",children:"\ud83d\uddd1\ufe0f Clear"})]}),(0,n.jsx)("button",{onClick:()=>c(!1),className:"close","aria-label":"Close chat",children:"\u2715"})]}),(0,n.jsx)("div",{className:"messages",ref:_,children:0===f.length?(0,n.jsxs)("div",{style:{textAlign:"center",padding:"60px 20px",color:"#666",fontSize:"14px"},children:[(0,n.jsx)("div",{style:{fontSize:"48px",marginBottom:"16px"},children:"\ud83e\udd16"}),(0,n.jsx)("div",{style:{fontWeight:600,marginBottom:"8px",color:"#667eea",fontSize:"16px"},children:"Ask me anything"}),(0,n.jsx)("div",{style:{fontSize:"12px",color:"#888",marginTop:"4px"},children:"Humanoid Robotics Expert"}),!a&&(0,n.jsx)("div",{style:{fontSize:"11px",color:"#888",marginTop:"12px",padding:"8px",background:"rgba(102, 126, 234, 0.05)",borderRadius:"8px",border:"1px solid rgba(102, 126, 234, 0.1)"},children:"\ud83d\udca1 Sign in to save chat history"})]}):f.map((e,t)=>(0,n.jsx)("div",{className:`message ${e.role}`,children:(0,n.jsx)("div",{className:"bubble",children:e.text||(0,n.jsx)("span",{style:{opacity:.5},children:"\u25cf\u25cf\u25cf"})})},t))}),(0,n.jsxs)("div",{className:"input-area",children:[(0,n.jsx)("input",{ref:D,value:p,onChange:e=>y(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),M())},placeholder:"Ask about ZMP, torque control, or Atlas...",disabled:b,"aria-label":"Message input"}),(0,n.jsx)("button",{onClick:M,disabled:b||!p.trim(),className:"send-btn","aria-label":"Send message",children:(0,n.jsx)("svg",{viewBox:"0 0 24 24",width:"22",height:"22",fill:"currentColor",children:(0,n.jsx)("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})})})]})]})]})]})}}}]);