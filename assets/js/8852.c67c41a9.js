"use strict";(globalThis.webpackChunkmy_book=globalThis.webpackChunkmy_book||[]).push([[8852],{8852:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var s=a(6540),o=a(8259),r=a(4848);const n=["Hello there!","Welcome to our AI Assistant!","Hi! How can I help you today?","Welcome! Ask me anything about humanoid robotics.","Hello! Ready to explore humanoid robotics?","Welcome! I'm here to help you learn."],l=()=>n[Math.floor(Math.random()*n.length)];function i(){const{user:e,token:t,isAuthenticated:a}=(0,o.A)(),[n,i]=(0,s.useState)("http://127.0.0.1:8000/chat"),[c,h]=(0,s.useState)("http://127.0.0.1:8000/api/chat-history"),[d,m]=(0,s.useState)(!1),[u,g]=(0,s.useState)([]),[f,p]=(0,s.useState)(null),[x,y]=(0,s.useState)([]),[b,w]=(0,s.useState)(""),[j,v]=(0,s.useState)(!1),[N,k]=(0,s.useState)(null),[S,C]=(0,s.useState)(!1),[E,$]=(0,s.useState)(!1),[T,A]=(0,s.useState)(""),[_,D]=(0,s.useState)(!0),z=(0,s.useRef)(null),P=(0,s.useRef)(null);(0,s.useEffect)(()=>{if("undefined"!=typeof window){const e=window.location.hostname.includes("github.io")?"https://physical-ai-humanoid-robotics-textbook-bgc0.onrender.com":"http://127.0.0.1:8000";i(`${e}/chat`),h(`${e}/api/chat-history`)}},[]),(0,s.useEffect)(()=>{A(a&&e?`Welcome, ${e.first_name}!`:l())},[a,e]),(0,s.useEffect)(()=>{a&&0===u.length?M():a||($(!1),y([]),g([]),p(null))},[a]),(0,s.useEffect)(()=>{f&&a&&O(f)},[f]);const H=()=>({Authorization:`Bearer ${t}`,"Content-Type":"application/json"}),M=async()=>{if(a)try{const e=await fetch(`${c}/chats`,{headers:H()});if(!e.ok)throw new Error("Failed to load chats");const t=(await e.json()).map(e=>({id:e.id,title:e.title,createdAt:e.created_at,updatedAt:e.updated_at,message_count:e.message_count}));g(t),t.length>0&&!f&&p(t[0].id)}catch(e){console.error("Error loading chats:",e)}finally{$(!1)}},O=async e=>{if(a)try{const t=await fetch(`${c}/chats/${e}`,{headers:H()});if(!t.ok)throw new Error("Failed to load messages");const a=await t.json();y(a.messages||[])}catch(t){console.error("Error loading messages:",t),y([])}};(0,s.useEffect)(()=>{z.current&&z.current.scrollTo({top:z.current.scrollHeight,behavior:"smooth"})},[x]),(0,s.useEffect)(()=>{d&&P.current&&setTimeout(()=>P.current.focus(),100)},[d]);const F=e=>{if(!e)return"";const t=new Date(e),a=new Date-t,s=Math.floor(a/6e4),o=Math.floor(a/36e5),r=Math.floor(a/864e5);return s<1?"Just now":s<60?`${s}m ago`:o<24?`${o}h ago`:r<7?`${r}d ago`:t.toLocaleDateString()},R=async()=>{if(!b.trim()||j)return;const t=b.trim();w("");let s=f;if(a&&!f)try{const e=await fetch(`${c}/chats`,{method:"POST",headers:H(),body:JSON.stringify({title:"New Conversation"})});if(!e.ok)throw new Error("Failed to create chat");const t=await e.json(),a={id:t.id,title:t.title,createdAt:t.created_at,updatedAt:t.updated_at,message_count:t.messages?.length||1};if(g(e=>[a,...e]),p(a.id),s=a.id,t.messages&&t.messages.length>0){const e=t.messages.map(e=>({role:e.role,text:e.text,id:e.id}));y(e)}}catch(l){console.error("Error creating new chat:",l),console.log("Falling back to anonymous chat mode")}const o={role:"user",text:t,id:Date.now()},r={role:"bot",text:"",id:Date.now()+1};y(e=>[...e,o,r]),v(!0);try{a&&s&&fetch(`${c}/chats/${s}/messages`,{method:"POST",headers:H(),body:JSON.stringify({role:"user",text:t})}).catch(e=>console.error("Error saving user message:",e));const o=x.slice(-10).map(e=>({role:"user"===e.role?"user":"assistant",content:e.text})),r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,stream:!0,user_level:a&&e?e.developer_level:"Intermediate",user_name:a&&e?e.first_name:null,conversation_history:o})});if(!r.ok)throw new Error("Network response was not ok");v(!1);const l=r.body.getReader(),h=new TextDecoder;let d="";try{for(;;){const{done:e,value:t}=await l.read();if(e){console.log("Stream completed. Total text length:",d.length);break}const a=h.decode(t,{stream:!0});d+=a,y(e=>{const t=[...e],a=t[t.length-1];return a&&"bot"===a.role&&(t[t.length-1]={...a,text:d}),t})}}catch(i){console.error("Streaming error:",i),console.log("Partial response received:",d.length,"characters")}a&&s&&fetch(`${c}/chats/${s}/messages`,{method:"POST",headers:H(),body:JSON.stringify({role:"bot",text:d})}).catch(e=>console.error("Error saving bot message:",e))}catch(l){console.error("Chat error:",l),y(e=>{const t=[...e];return t.pop(),t.push({role:"bot",text:"\u26a0\ufe0f Connection error. Please check if the backend is running on http://127.0.0.1:8000",id:Date.now()}),t}),v(!1)}},B=async(e,t)=>{if(t&&t.stopPropagation(),a)if(N===e){console.log("Deleting chat:",e);const t=u.filter(t=>t.id!==e);g(t),f===e&&(t.length>0?p(t[0].id):(p(null),y([]))),k(null);try{const t=await fetch(`${c}/chats/${e}`,{method:"DELETE",headers:H()});if(!t.ok){const e=await t.json().catch(()=>({detail:"Failed to delete chat"}));console.error("Delete chat error:",e),M()}console.log("Chat deleted successfully")}catch(s){console.error("Error deleting chat:",s),M()}}else k(e),setTimeout(()=>k(null),3e3)};return"undefined"==typeof window?null:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"fab",onClick:()=>m(!d),role:"button","aria-label":"Toggle chat",children:(0,r.jsx)("svg",{viewBox:"0 0 24 24",width:"30",height:"30",fill:"currentColor",style:{transform:d?"rotate(180deg)":"rotate(0)",transition:"transform 0.3s"},children:d?(0,r.jsx)("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}):(0,r.jsx)("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"})})}),d&&(0,r.jsxs)("div",{className:"chat-container",children:[(0,r.jsxs)("div",{className:"sidebar",children:[(0,r.jsxs)("div",{className:"sidebar-header",children:[(0,r.jsx)("button",{onClick:async()=>{if(!a)return y([]),void p(null);try{const e=await fetch(`${c}/chats`,{method:"POST",headers:H(),body:JSON.stringify({title:"New Conversation"})});if(!e.ok)throw new Error("Failed to create chat");const t=await e.json(),a={id:t.id,title:t.title,createdAt:t.created_at,updatedAt:t.updated_at,message_count:t.messages?.length||1};if(g(e=>[a,...e]),p(a.id),t.messages&&t.messages.length>0){const e=t.messages.map(e=>({role:e.role,text:e.text,id:e.id}));y(e)}}catch(e){console.error("Error creating new chat:",e),y([]),p(null)}},className:"new-chat-btn",disabled:j,children:(0,r.jsx)("span",{style:{position:"relative",zIndex:1},children:a?"+ New Chat":"Clear Chat"})}),u.length>0&&a&&(0,r.jsx)("button",{onClick:()=>C(!S),className:"clear-all-btn",title:"Clear all history",children:"\ud83d\uddd1\ufe0f Clear All"}),S&&(0,r.jsxs)("div",{className:"confirm-dialog",children:[(0,r.jsx)("p",{children:"Delete all chats?"}),(0,r.jsxs)("div",{className:"confirm-buttons",children:[(0,r.jsx)("button",{onClick:async()=>{if(a){g([]),p(null),y([]),C(!1);try{(await fetch(`${c}/chats`,{method:"DELETE",headers:H()})).ok||M()}catch(e){console.error("Error clearing all history:",e),M()}}},className:"confirm-yes",children:"Yes"}),(0,r.jsx)("button",{onClick:()=>C(!1),className:"confirm-no",children:"No"})]})]})]}),(0,r.jsx)("div",{className:"chat-list",children:a?E?(0,r.jsx)("div",{className:"empty-history",children:(0,r.jsx)("p",{children:"Loading..."})}):0===u.length?(0,r.jsxs)("div",{className:"empty-history",children:[(0,r.jsx)("p",{children:"No chat history"}),(0,r.jsx)("p",{className:"empty-hint",children:"Start a new conversation!"})]}):u.map(e=>(0,r.jsxs)("div",{className:`chat-item ${f===e.id?"active":""} ${N===e.id?"delete-confirm":""}`,onClick:()=>{p(e.id),k(null)},role:"button",tabIndex:0,children:[(0,r.jsxs)("div",{className:"chat-item-content",children:[(0,r.jsx)("span",{className:"chat-item-title",children:e.title}),e.createdAt&&(0,r.jsx)("span",{className:"chat-item-time",children:F(e.createdAt)})]}),N===e.id?(0,r.jsx)("button",{className:"delete-chat-btn confirm",onClick:t=>B(e.id,t),"aria-label":"Confirm delete",title:"Confirm delete",children:"\u2713"}):(0,r.jsx)("button",{className:"delete-chat-btn",onClick:t=>B(e.id,t),"aria-label":"Delete chat",title:"Delete chat",children:"\ud83d\uddd1\ufe0f"})]},e.id)):(0,r.jsxs)("div",{className:"empty-history",children:[(0,r.jsx)("p",{style:{fontSize:"13px",marginBottom:"8px"},children:"\ud83d\udcac Chat freely!"}),(0,r.jsx)("p",{className:"empty-hint",style:{fontSize:"12px",lineHeight:"1.4"},children:"Sign in to save your chat history across sessions"})]})})]}),(0,r.jsxs)("div",{className:"main-chat",children:[(0,r.jsxs)("div",{className:"header",children:[(0,r.jsxs)("div",{className:"header-left",children:[(0,r.jsx)("h3",{children:a&&e?`\ud83e\udd16 Welcome, ${e.first_name}!`:"\ud83e\udd16 Humanoid Robotics Expert"}),f&&a&&(0,r.jsx)("button",{onClick:async()=>{if(f&&a&&window.confirm("Clear all messages in this chat? This cannot be undone."))try{if(!(await fetch(`${c}/chats/${f}/clear`,{method:"PUT",headers:H()})).ok)throw new Error("Failed to clear chat");await O(f)}catch(e){console.error("Error clearing chat:",e),alert("Failed to clear chat. Please try again.")}},className:"clear-chat-btn",title:"Clear current chat","aria-label":"Clear current chat",children:"\ud83d\uddd1\ufe0f Clear"})]}),(0,r.jsx)("button",{onClick:()=>m(!1),className:"close","aria-label":"Close chat",children:"\u2715"})]}),(0,r.jsx)("div",{className:"messages",ref:z,children:0===x.length?(0,r.jsxs)("div",{style:{textAlign:"center",padding:"60px 20px",color:"#666",fontSize:"14px"},children:[(0,r.jsx)("div",{style:{fontSize:"48px",marginBottom:"16px"},children:"\ud83e\udd16"}),(0,r.jsx)("div",{style:{fontWeight:600,marginBottom:"8px",color:"#667eea",fontSize:"16px"},children:"Ask me anything"}),(0,r.jsx)("div",{style:{fontSize:"12px",color:"#888",marginTop:"4px"},children:"Humanoid Robotics Expert"}),!a&&(0,r.jsx)("div",{style:{fontSize:"11px",color:"#888",marginTop:"12px",padding:"8px",background:"rgba(102, 126, 234, 0.05)",borderRadius:"8px",border:"1px solid rgba(102, 126, 234, 0.1)"},children:"\ud83d\udca1 Sign in to save chat history"})]}):x.map((e,t)=>(0,r.jsx)("div",{className:`message ${e.role}`,children:(0,r.jsx)("div",{className:"bubble",children:e.text||(0,r.jsx)("span",{style:{opacity:.5},children:"\u25cf\u25cf\u25cf"})})},t))}),(0,r.jsxs)("div",{className:"input-area",children:[(0,r.jsx)("input",{ref:P,value:b,onChange:e=>w(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),R())},placeholder:"Ask about ZMP, torque control, or Atlas...",disabled:j,"aria-label":"Message input"}),(0,r.jsx)("button",{onClick:R,disabled:j||!b.trim(),className:"send-btn","aria-label":"Send message",children:(0,r.jsx)("svg",{viewBox:"0 0 24 24",width:"22",height:"22",fill:"currentColor",children:(0,r.jsx)("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})})})]})]})]})]})}}}]);